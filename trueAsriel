_G.targetr = nil

local m1 = true

local player = game.Players.LocalPlayer
local char = player.Character
local root = char.HumanoidRootPart
local rootpart = char.HumanoidRootPart

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LP = Players.LocalPlayer

local Remotes = {}

for idx, val in pairs(game:GetService("ReplicatedStorage"):GetChildren()) do
    if val:IsA("RemoteEvent") then
        Remotes[val.Name] = val
    end
end

local attack_tools = {
    "Axe",
    "Pickaxe",
    "Crowbar",
    "Hammer",
    "Knife",
    "Fist"
}

local function CheckRange(part1, part2, stud)
    range = (part1.Position - part2.Position).Magnitude
    if range < stud then
        return true
    end
    return false
end



function anime(id)
				local animation1 = Instance.new("Animation")
				--animation1.Name = "AttackMove"
				animation1.AnimationId = "rbxassetid://"..id
				local anim1 = game.Players.LocalPlayer.Character.Humanoid:LoadAnimation(animation1)
				anim1.Name = "AttackMove"
				task.wait()
				anim1:Play()
end
--[[
task.spawn(function()
while task.wait() do
task.wait(0.1)
	--if char:FindFirstChild("Animate") then
		for i,v in ipairs(char.Humanoid:GetPlayingAnimationTracks()) do
			--print(v)
			if LP.Character.IsCuffed.Value == false then
			v:Stop()
			end 
		end 
	--end
end
end)
]]
function grabRemote()
	pcall(function()
		for idx, plr in pairs(Players:GetPlayers()) do
			if plr ~= LP 
            and CheckRange(LP.Character.HumanoidRootPart, plr.Character.HumanoidRootPart, 20)
			and plr.Character.Hostile.Value 
            --and LP.Team ~= plr.Team 
            and plr.Character.Humanoid.Health ~= 0 
			then
                print(plr)
				Remotes["Grab"]:FireServer(plr.Character, "Grab")
			end
		end
	end) 
end

function attack()
	pcall(function()
		local tool
		for i,v in pairs(attack_tools) do
			local t = LP.Character:FindFirstChild(v)
			if t then
				tool = t
				break
			end
		end
		for idx, plr in pairs(Players:GetPlayers()) do
			if
				plr ~= LP and CheckRange(LP.Character.HumanoidRootPart, plr.Character.HumanoidRootPart, 15)
				 and plr.Character.Hostile.Value and LP.Team ~= plr.Team and plr.Character.Humanoid.Health ~= 0 
			then
				if LP.Team.Name == "Civilian" and plr.Team.Name ~= "Guard" then
				Remotes["Combat"]:FireServer(LP.Character, plr.Character.Head, tool)
				task.wait()
				elseif LP.Team.Name ~= "Civilian" then
					Remotes["Combat"]:FireServer(LP.Character, plr.Character.Head, tool)
					task.wait()
				end
			end
		end
	end) 
end

game:GetService("UserInputService").InputBegan:Connect(function(inp)
    if inp.KeyCode == Enum.KeyCode.Q then


		if player.Character:FindFirstChild("Axe") then
			anime(7286445304)
			attack()
		elseif player.Character:FindFirstChild("Crowbar") then
			if m2 == true then
			anime(7137390931)
			attack()
			m2 = false
			else
				anime(7137385893)
				attack()
				m2 = true
			end
		elseif player.Character:FindFirstChild("Pickaxe") then
			anime(7098129399)
			attack()
		elseif player.Character:FindFirstChild("Knife") then
			if m1 == true then
				anime(7575196416)
				attack()
				m1 = false
			else
				anime(7562485782)
				attack()
				m1 = true
			end
		elseif player.Character:FindFirstChild("Fist") then
			if m3 == true then
				anime(6884302925)
				attack()
				m3 = false
			else
				anime(6884306689)
				attack()
				m3 = true
			end
		elseif player.Character:FindFirstChild("Hammer") then
			anime(6884398841)
			attack()
		elseif player.Character:FindFirstChild("Food") then
			Remotes["EatingEvent"]:FireServer(
				LP.Character,
				game:GetService("Players").LocalPlayer.Character.Food,
				"Heal")
		elseif player.Character:FindFirstChild("Hamburger") then
			Remotes["EatingEvent"]:FireServer(
				LP.Character,
				game:GetService("Players").LocalPlayer.Character.Hamburger,
				"Heal")
		elseif player.Character:FindFirstChild("Taser") then
			pos = game:GetService("Players").LocalPlayer.Character.Torso.CFrame.Position
			tpos = game:GetService("Players"):WaitForChild(_G.targetr).Character.Torso.CFrame.Position

			spawn(function()	
			local args = {
					[1] = "Generate",
					[2] = game:GetService("Players").LocalPlayer.Character.Taser,
					[3] = Vector3.new(pos.X,pos.Y,pos.Z),
					[4] = Vector3.new(tpos.X,tpos.Y,tpos.Z)
				}
				
				game:GetService("ReplicatedStorage"):WaitForChild("Tase"):FireServer(unpack(args))
			end)

			local args = {
				[1] = "Hit",
				[2] = game:GetService("Players").LocalPlayer.Character.Taser,
				[3] = game:GetService("Players"):WaitForChild(_G.targetr).Character.Head
			}
			
			game:GetService("ReplicatedStorage"):WaitForChild("Tase"):FireServer(unpack(args))
			wait()
			local args = {
				[1] = "Recharge",
				[2] = game:GetService("Players").LocalPlayer.Character.Taser
			}
			
			game:GetService("ReplicatedStorage"):WaitForChild("Tase"):FireServer(unpack(args))


		end

	end
end)

game:GetService("UserInputService").InputBegan:Connect(function(inp)
    if inp.KeyCode == Enum.KeyCode.F then
		grabRemote()
	end
end)

game:GetService("UserInputService").InputBegan:Connect(function(inp)
    if inp.KeyCode == Enum.KeyCode.V then
		char = game.Players.LocalPlayer.Character
		spawn(function()
			if char.HumanoidRootPart:FindFirstChild("Client") then
				char.HumanoidRootPart:FindFirstChild("Client"):Destroy()
			end
		end)
		spawn(function()
		anime(7568092298)
		end)
          --char.Humanoid:ChangeState(Enum.HumanoidStateType.Swimming)
          tar = char.HumanoidRootPart.CFrame*CFrame.new(0,15,0) + game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame.lookVector * 60
          --char.Humanoid:ChangeState(Enum.HumanoidStateType.Swimming)
          v2 = Instance.new('BodyPosition',char.HumanoidRootPart) 
          fol = Instance.new('Folder',v2)
          v2.Name = 'Client' 
          v2.MaxForce = Vector3.new(1,1,1)*100000 
          v2.D = 2500 
          v2.P = 60000 
          v2.Position = (tar).p
		  wait(0.2)
		  v2:Destroy()
	end
end)


-- 필요한 서비스 불러오기
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local GuiService = game:GetService("GuiService")

-- 플레이어 GUI 생성
local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "TargetInfoGui"
screenGui.Parent = playerGui

-- UI 요소 생성
local nameLabel = Instance.new("TextLabel")
nameLabel.Size = UDim2.new(0, 200, 0, 50)
nameLabel.Position = UDim2.new(0.5, -100, 0.1, 0)
nameLabel.Font = Enum.Font.SourceSansBold
nameLabel.TextSize = 20
nameLabel.Parent = screenGui

local distanceLabel = Instance.new("TextLabel")
distanceLabel.Size = UDim2.new(0, 200, 0, 50)
distanceLabel.Position = UDim2.new(0.5, -100, 0.2, 0)
distanceLabel.Font = Enum.Font.SourceSans
distanceLabel.TextSize = 16
distanceLabel.Parent = screenGui

-- 'H' 키를 지정
local selectKey = Enum.KeyCode.H

-- 'H' 키가 눌렸을 때 실행될 함수
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == selectKey then
        -- 현재 플레이어 얻기
        local localPlayer = Players.LocalPlayer
        
        -- 만약 로컬 플레이어가 "Guard" 팀이고 타겟이 "Civilian" 팀이면 동작 중지
        if localPlayer.Team.Name == "Guard" then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= localPlayer and player.Team.Name == "Civilian" then
                    return
                end
            end
        end
        
        -- 만약 로컬 플레이어가 "Civilian" 팀이고 타겟이 "Guard" 팀이면 동작 중지
        if localPlayer.Team.Name == "Civilian" then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= localPlayer and player.Team.Name == "Guard" then
                    return
                end
            end
        end
        
        -- 마우스의 현재 위치 얻기
        local mouse = Players.LocalPlayer:GetMouse()
        local mousePosition = mouse.Hit.p
        
        -- 가장 가까운 다른 팀 플레이어 찾기
        local closestPlayer = nil
        local shortestDistance = math.huge
        
        for _, player in ipairs(Players:GetPlayers()) do
            -- 로컬 플레이어와 같은 팀이면서 검사
            if player.Team ~= localPlayer.Team and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local playerPosition = player.Character.HumanoidRootPart.Position
                local distance = (playerPosition - mousePosition).magnitude
                
                -- 이전에 찾은 플레이어보다 더 가까운 플레이어를 찾으면 갱신
                if distance < shortestDistance then
                    closestPlayer = player
                    shortestDistance = distance
                end
            end
        end
        
        -- 가장 가까운 플레이어를 찾은 경우, 정보를 GUI로 출력
        if closestPlayer then
			_G.targetr = closestPlayer.Name
            nameLabel.Text = "Target: " .. closestPlayer.Name
            distanceLabel.Text = "Distance: " .. math.floor(shortestDistance) .. " studs"
        else
            nameLabel.Text = "No target found"
            distanceLabel.Text = ""
        end
    end
end)
